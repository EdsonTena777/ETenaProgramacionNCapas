<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">    
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    </head>
    <body class="bg-light">
        <div class="container-fluid">
            <div class="d-flex align-items-center p-3 my-3 text-white bg-primary rounded shadow-sm">
                <div class="col-6">
                    <h5 class="text-white mt-2 ">Edición de usuario</h5>
                </div>
                <div class="col-2 py-4 text-center">  
                </div>
                <div class="col-4 text-center">
                    <a href="/usuario" class="btn btn-warning w-25 rounded bi bi-arrow-return-left"></a>
                </div>
            </div>
        </div>
        <div class="container-fluid py-2 px-3">
            <div class="row">
                <div class="col-md-6">
                    <div class="p-4 shadow-lg rounded bg-white h-100">
                        <div class="col-md-12 mb-5">
                            <label class="form-label fw-bold">Imagen</label>
                            <img th:if="${usuario.imagen != null}" th:src="'data:image/jpeg;base64,' + ${usuario.imagen}" style="max-width: 250px; margin-bottom: 20px; max-height: auto" class="img-thumbnail mx-auto d-block"/>
                            <img th:unless="${usuario.imagen != null}"  th:src="@{/img/usuario.png}" style="max-width: 250px; margin-bottom: 20px; max-height: auto" class="img-thumbnail mx-auto d-block"/>
                        </div>
                        <div class="col-md-12 mb-5 text-end">
                            <button type="button" class="btn btn-warning bi bi-pencil-square" data-bs-toggle="modal" data-bs-target="#myModal">Editar</button>
                            <div id="myModal" class="modal fade" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="exampleModalLabel">Cambiar imagen</h5>
                                        </div>
                                        <div class="modal-body text-center">
                                            <img id="ImagenPrincipal" style="max-width: 250px; margin-bottom: 20px" th:if="${usuario.imagen != null}" th:src="'data:image/png;base64,' + ${usuario.imagen}"/>
                                            <img id="ImagenPrincipal" th:unless="${usuario.imagen != null}"  th:src="@{/img/usuario.png}" style="max-width: 250px; margin-bottom: 20px; max-height: auto" class="img-thumbnail mx-auto d-block"/>
                                            <input type="file" class="form-control mb-3 mx-1" name="imagenFile" id="imagenFile" accept="image/*">
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                                            <button type="button" id="btnActualizarImagen" class="btn btn-success">Actualizar Imagen</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <label class="form-label fw-bold">Información</label>
                        <div class="row mb-4 mt-4">
                            <div class="col-md-4">
                                <label class="form-label">Nombre</label>
                                <input type="text" class="form-control" th:value="${usuario.Nombre}" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Apellido Paterno</label>
                                <input type="text" class="form-control" th:value="${usuario.ApellidoPaterno}" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Apellido Materno</label>
                                <input type="text" class="form-control" th:value="${usuario.ApellidoMaterno}" readonly>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label">CURP</label>
                                <input type="text" class="form-control" th:value="${usuario.CURP}" readonly>
                            </div>
                            <div class="col-sm-4">
                                <label class="form-label">Fecha de nacimiento</label>
                                <input type="date" class="form-control" th:value="${#dates.format(usuario.FechaNacimiento,'yyyy-MM-dd')}" readonly>
                            </div>
                            <div class="col-sm-4">
                                <label class="form-label">Sexo</label>
                                <input type="text" class="form-control" th:value="${usuario.Sexo.toString() == 'M' ? 'Masculino' : 'Femenino'}" readonly>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label">Usuario</label>
                                <input type="text" class="form-control" th:value="${usuario.Username}" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Rol</label>
                                <input type="text" class="form-control" th:value="${usuario.roles.NombreRol}" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Email</label>
                                <input type="text" class="form-control" th:value="${usuario.Email}" readonly>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Telefono</label>
                                <input type="text" class="form-control" th:value="${usuario.Telefono}" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Celular</label>
                                <input type="text" class="form-control" th:value="${usuario.Celular}" readonly>
                            </div>
                        </div>
                        <div class="col-md-12 mb-5 text-end">
                            <button type="button" class="btn btn-warning bi bi-pencil-square" data-bs-toggle="modal" data-bs-target="#EInformacion">Editar</button>
                            <div id="EInformacion" class="modal fade" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="exampleModalLabel">Editar información</h5>
                                        </div>
                                        <div class="modal-body text-center">
                                            <div class="row mb-4">
                                                <div class="col-md-4">
                                                    <label class="form-label">Nombre</label>
                                                    <input type="text" class="form-control" id="Nombre" th:value="${usuario.Nombre}">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Apellido Paterno</label>
                                                    <input type="text" class="form-control" id="ApellidoPaterno" th:value="${usuario.ApellidoPaterno}" >
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Apellido Materno</label>
                                                    <input type="text" class="form-control" id="ApellidoMaterno" th:value="${usuario.ApellidoMaterno}">
                                                </div>
                                            </div>
                                            <div class="row mb-4">
                                                <div class="col-md-4">
                                                    <label class="form-label">CURP</label>
                                                    <input type="text" class="form-control" id="CURP" th:value="${usuario.CURP}">
                                                </div>
                                                <div class="col-sm-4">
                                                    <label class="form-label">Fecha de nacimiento</label>
                                                    <input id="FechaNacimientoUsuario" type="date" class="form-control" th:value="${#dates.format(usuario.FechaNacimiento,'yyyy-MM-dd')}" onkeydown="return false">                                                </div>
                                                <div class="col-sm-3">
                                                    <label class="form-label d-block">Sexo</label> 
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="radio" name="Sexo" value="M" id="sexoM" th:checked="${#strings.trim(usuario.Sexo) == 'M'}">
                                                        <label class="form-check-label" for="sexoM">Masculino</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="radio" name="Sexo" value="F" id="sexoF" th:checked="${#strings.trim(usuario.Sexo) == 'F'}">
                                                        <label class="form-check-label" for="sexoF">Femenino</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row mb-4">
                                                <div class="col-md-4">
                                                    <label class="form-label">Usuario</label>
                                                    <input type="text" class="form-control" id="Username" th:value="${usuario.Username}">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Rol</label>
                                                        <select class="form-select" id="IdRol">
                                                            <option 
                                                                th:each="rol : ${roles}" 
                                                                th:value="${rol.idRol}" 
                                                                th:text="${rol.NombreRol}"
                                                                th:selected="${rol.idRol == usuario.roles.idRol}">
                                                            </option>
                                                        </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Email</label>
                                                    <input type="text" class="form-control" id="Email" th:value="${usuario.Email}" >
                                                </div>
                                            </div>    
                                            <div class="row mb-4">
                                                <div class="col-md-6">
                                                    <label class="form-label">Telefono</label>
                                                    <input type="text" class="form-control" id="Telefono" th:value="${usuario.Telefono}" >
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Celular</label>
                                                    <input type="text" class="form-control" id="Celular" th:value="${usuario.Celular}" >
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                                            <button type="button" class="btn btn-success" id="btnGuardarCambios">Actualizar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="p-4 shadow-lg rounded bg-white h-100">
                        <div class="col-md-12">
                            <table class="table table-bordered align-middle rounded">
                                <thead class="table-light text-center">
                                    <tr>
                                        <th scope="col" style="width: 75%;">Direccion</th>
                                        <th scope="col" style="width: 25%">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:if="${#lists.isEmpty(usuario.Direcciones)}">
                                        <td colspan="2" class="text-center text-muted italic">
                                            Sin direcciones registradas
                                        </td>
                                    </tr>
                                    <tr th:each="direccion : ${usuario.Direcciones}" 
                                        th:unless="${#lists.isEmpty(usuario.Direcciones)}">
                                        <td>
                                            <div class="pb-1">
                                                <i class="bi bi-geo-alt-fill text-danger"></i>
                                                <span>
                                                    <span th:text="${direccion.Calle}"></span>
                                                    #
                                                    <span th:text="${direccion.NumeroExterior}"></span>

                                                    <span th:if="${direccion.NumeroInterior != null}">
                                                        #
                                                        <span th:text="${direccion.NumeroInterior}"></span>
                                                    </span>

                                                    , Col.
                                                    <span th:text="${direccion.Colonia.Nombre}"></span>
                                                </span>
                                                <br>
                                                <small class="text-muted">
                                                    <span th:text="${direccion.Colonia.Municipio.Nombre}"></span>,
                                                    <span th:text="${direccion.Colonia.Municipio.Estado.Nombre}"></span>
                                                </small>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="btn btn-danger bi bi-trash w-25" th:onclick="'ConfirmarDelete(' + ${direccion.idDireccion} + ')'" style="cursor: pointer;"></div>
                                            <button type="button"
                                                class="btn btn-warning btnEditarDireccion"
                                                th:data-id="${direccion.idDireccion}">
                                            Editar
                                        </button>                    
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="modal fade" id="modalEditarDireccion" tabindex="-1">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">

                                        <div class="modal-header">
                                            <h5 class="modal-title">Editar Dirección</h5>
                                        </div>

                                        <div class="modal-body">

                                            <input type="hidden" id="IdDireccion">

                                            <div class="row mb-3">
                                                <div class="col-md-3">
                                                    <label>Calle</label>
                                                    <input type="text" id="Calle" class="form-control">
                                                </div>
                                                <div class="col-md-3">
                                                    <label>No. Exterior</label>
                                                    <input type="text" id="NumeroExterior" class="form-control">
                                                </div>
                                                <div class="col-md-3">
                                                    <label>No. Interior</label>
                                                    <input type="text" id="NumeroInterior" class="form-control">
                                                </div>
                                                <div class="col-md-3">
                                                    <label>Código Postal</label>
                                                    <input type="text" id="CodigoPostal" class="form-control" readonly>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-3">
                                                    <label>País</label>
                                                    <select id="ddlPais" class="form-select"></select>
                                                </div>

                                                <div class="col-md-3">
                                                    <label>Estado</label>
                                                    <select id="ddlEstado" class="form-select"></select>
                                                </div>

                                                <div class="col-md-3">
                                                    <label>Municipio</label>
                                                    <select id="ddlMunicipio" class="form-select"></select>
                                                </div>

                                                <div class="col-md-3">
                                                    <label>Colonia</label>
                                                    <select id="ddlColonia" class="form-select"></select>
                                                </div>
                                            </div>

                                        </div>

                                        <div class="modal-footer">
                                            <button class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                                            <button type="button" class="btn btn-warning" id="btnGuardarDireccion">Guardar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end mt-3">
                                <button type="button"
                                        class="btn btn-success"
                                        id="btnAbrirAgregarDireccion"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalAgregarDireccion">
                                    <i class="bi bi-plus-circle"></i>        
                                </button>        
                            </div>
                            <div class="modal fade" id="modalAgregarDireccion" tabindex="-1">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5>Agregar direccion</h5>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row mb-3">
                                                <div class="col-md-3">
                                                    <label>calle</label>
                                                    <input type="text" id="CalleAdd" class="form-control">
                                                </div>
                                                <div class="col-md-3">
                                                    <label>Numero exterior</label>
                                                    <input type="text" id="NumeroExteriorAdd" class="form-control">
                                                </div>
                                                <div class="col-md-3">
                                                    <label>Numero interior</label>
                                                    <input type="text" id="NumeroInteriorAdd" class="form-control">
                                                </div>
                                                <div class="col-md-3">
                                                    <label>Codigo Postal</label>
                                                    <input type="text" id="CodigoPostalAdd" class="form-control" readonly>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-3">
                                                    <label>Pais</label>
                                                    <select id="ddlPaisAdd" class="form-select"></select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label>Estado</label>
                                                    <select id="ddlEstadoAdd" class="form-select"></select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label>Municipio</label>
                                                    <select id="ddlMunicipioAdd" class="form-select"></select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label>Colonia</label>
                                                    <select id="ddlColoniaAdd" class="form-select"></select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                                            <button type="button" class="btn btn-success" id="btnGuardarDireccionAdd">Guardar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script th:inline="javascript">
    let base64Temporal = "";

    $(document).on('change', '#imagenFile', function (e) {

        console.log("Evento change detectado"); 

        let file = e.target.files[0];

        if (!file) return;

        let reader = new FileReader();

        reader.onload = function (event) {


            base64Temporal = event.target.result
                .replace("data:", "")
                .replace(/^.+,/, "");

            console.log("Base64 cargado");

            $('#ImagenPrincipal').attr('src', event.target.result);
        };

        reader.readAsDataURL(file);
    });


    $(document).on('click', '#btnActualizarImagen', function () {

        console.log(base64Temporal);

        if (base64Temporal === "") {
            Swal.fire("Selecciona una imagen primero");
            return;
        }

        let idUsuario = [[${usuario.idUsuario}]];

        $.ajax({
            url: '/usuario/updateImagen',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                idUsuario: idUsuario,
                imagen: base64Temporal
            }),
            success: function () {
                Swal.fire("Imagen actualizada", "", "success")
                .then(() => location.reload());
            },
            error: function () {
                Swal.fire("Error AJAX");
            }
        });
    });
    $(document).on('click', '#btnGuardarCambios', function () {

        let sexoSeleccionado = $("input[name='Sexo']:checked").val();

        let usuario = {
            idUsuario: [[${usuario.idUsuario}]],
            username: $("#Username").val(),
            nombre: $("#Nombre").val(),
            apellidoPaterno: $("#ApellidoPaterno").val(),
            apellidoMaterno: $("#ApellidoMaterno").val(),
            email: $("#Email").val(),
            sexo: sexoSeleccionado,
            telefono: $("#Telefono").val(),
            celular: $("#Celular").val(),
            curp: $("#CURP").val(),
            fechaNacimiento: $("#FechaNacimientoUsuario").val(),
            roles: {
                idRol: $("#IdRol").val()
            }
        };

        $.ajax({
            url: '/usuario/update',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(usuario),
            success: function (response) {
                Swal.fire({
                    title: "Usuario actualizado",
                    icon: "success"
                }).then(() => {
                    location.reload();
                });
            },
            error: function () {
                Swal.fire("Error al actualizar");
            }
        });

    });
    
    function ConfirmarDelete(idDireccion) {
            Swal.fire({
                title: "¿Estás seguro?",
                text: "No podrá revertirse",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sí, eliminar"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: "GET",
                        url: `/direccion/delete/${idDireccion}`, 
                        data: { idDireccion: idDireccion }, 
                        success: function(respuesta) {
                            console.log(respuesta);
                            if (respuesta.correct) {
                                Swal.fire({
                                    title: "¡Eliminado!",
                                    text: "Tu direccion ha sido eliminado con éxito.",
                                    icon: "success",
                                    timer: 1500,
                                    showConfirmButton: false
                                }).then(() => {
                                    location.reload(); 
                                });
                            } else {
                                Swal.fire("Error", respuesta.errorMessage, "error");
                            }
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            console.error("Error detallado:", textStatus, errorThrown);
                            Swal.fire("Error", "No se pudo procesar la respuesta del servidor", "error");
                        }
                    });
                }
            });
        }
        
    $(document).on("click", ".btnEditarDireccion", function () {

    let idDireccion = $(this).data("id");

    $.ajax({
        url: "/direccion/getbyid",
        type: "GET",
        data: { idDireccion: idDireccion },
        success: function (response) {
            console.log(response);

            if (response.correct) {

                let d = response.object;

                $("#IdDireccion").val(d.idDireccion);
                $("#Calle").val(d.Calle);
                $("#NumeroExterior").val(d.NumeroExterior);
                $("#NumeroInterior").val(d.NumeroInterior);

                cargarPaises(d.Colonia.Municipio.Estado.Pais.idPais,
                             d.Colonia.Municipio.Estado.idEstado,
                             d.Colonia.Municipio.idMunicipio,
                             d.Colonia.idColonia);

                let modal = new bootstrap.Modal(document.getElementById('modalEditarDireccion'));
                modal.show();
            }
        }
    });
});

function cargarPaises(idPaisSeleccionado, idEstado, idMunicipio, idColonia) {

    $.get("/catalogo/pais/getall", function (response) {

        let ddl = $("#ddlPais");
        ddl.empty();

        response.objects.forEach(p => {
            ddl.append(`<option value="${p.idPais}">${p.Nombre}</option>`);
        });

        ddl.val(idPaisSeleccionado);

        cargarEstados(idPaisSeleccionado, idEstado, idMunicipio, idColonia);
    });
}
function cargarEstados(idPais, idEstadoSeleccionado, idMunicipio, idColonia) {

    $.get("/catalogo/estado/getbyidpais", { idPais: idPais }, function (response) {

        let ddl = $("#ddlEstado");
        ddl.empty();

        response.objects.forEach(e => {
            ddl.append(`<option value="${e.idEstado}">${e.Nombre}</option>`);
        });

        ddl.val(idEstadoSeleccionado);

        cargarMunicipios(idEstadoSeleccionado, idMunicipio, idColonia);
    });
}
function cargarMunicipios(idEstado, idMunicipioSeleccionado, idColonia) {

    $.get("/catalogo/municipio/getbyidestado", { idEstado: idEstado }, function (response) {

        let ddl = $("#ddlMunicipio");
        ddl.empty();

        response.objects.forEach(m => {
            ddl.append(`<option value="${m.idMunicipio}">${m.Nombre}</option>`);
        });

        ddl.val(idMunicipioSeleccionado);

        cargarColonias(idMunicipioSeleccionado, idColonia);
    });
}
function cargarColonias(idMunicipio, idColoniaSeleccionada) {

  $.get("/catalogo/colonia/getbyidmunicipio", { idMunicipio: idMunicipio }, function (response) {

    let ddl = $("#ddlColonia");
    ddl.empty();

    response.objects.forEach(c => {
      const id = c.idColonia ?? c.IdColonia;
      const nombre = c.nombre ?? c.Nombre;
      const cp = c.codigoPostal ?? c.CodigoPostal ?? c.CP ?? "";
      
      ddl.append(`<option value="${id}" data-cp="${cp}">${nombre}</option>`);
    });

    ddl.val(idColoniaSeleccionada);

    
    let cpSelected = $("#ddlColonia option:selected").data("cp") || "";
    $("#CodigoPostal").val(cpSelected);
  });
}
$("#ddlPais").change(function () {
    cargarEstados($(this).val(), null, null, null);
});

$("#ddlEstado").change(function () {
    cargarMunicipios($(this).val(), null, null);
});

$("#ddlMunicipio").change(function () {
    cargarColonias($(this).val(), null);
});
$("#ddlColonia").on("change", function () {
  let cp = $("#ddlColonia option:selected").data("cp") || "";
  $("#CodigoPostal").val(cp);
});
$(document).on("click", "#btnGuardarDireccion", function () {

  const idDireccion = parseInt($("#IdDireccion").val(), 10);
  const calle = $("#Calle").val()?.trim() || "";
  const numeroExterior = $("#NumeroExterior").val()?.trim() || "";
  const numeroInterior = $("#NumeroInterior").val()?.trim() || "";
  const idColonia = parseInt($("#ddlColonia").val(), 10);

  if (!idDireccion || isNaN(idDireccion)) {
    alert("No se pudo obtener el IdDireccion. Abre el modal desde Editar.");
    return;
  }

  if (!idColonia || isNaN(idColonia)) {
    alert("Selecciona una colonia válida.");
    return;
  }

  if (!calle) {
    alert("La calle es obligatoria.");
    return;
  }

  const payload = {
    idDireccion: idDireccion,
    Calle: calle,
    NumeroExterior: numeroExterior,
    NumeroInterior: numeroInterior,
    Colonia: {
      idColonia: idColonia
    }
  };

  console.log("PAYLOAD UPDATE:", payload);

  $.ajax({
    url: "/direccion/update",
    type: "POST",
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    data: JSON.stringify(payload),
    success: function (res) {
      console.log("UPDATE RES:", res);

      if (res.correct) {
        const modalEl = document.getElementById("modalEditarDireccion");
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.hide();
        Swal.fire({
            icon: 'success',
            title: 'Dirección actualizada',
            showConfirmButton: false,
            timer: 1500
          }).then(() => {
            location.reload();
          });

      } else {
        alert(res.errorMessage || "Error al actualizar la dirección.");
      }
    },
    error: function (xhr) {
      console.log("ERROR UPDATE:", xhr);
      alert("Error de comunicación con el servidor al actualizar.");
    }
  });
});
    $('#modalAgregarDireccion').on('shown.bs.modal', function () {
      console.log("Modal Agregar abierto ✅");

      resetSelect("#ddlEstadoAdd", "Seleccione");
      resetSelect("#ddlMunicipioAdd", "Seleccione");
      resetSelect("#ddlColoniaAdd", "Seleccione");
      $("#CodigoPostalAdd").val("");

      cargarPaisesAdd();
    });

    function resetSelect(selector, placeholder) {
      const ddl = $(selector);
      ddl.empty();
      ddl.append(`<option value="" selected disabled>${placeholder}</option>`);
    }

    function cargarPaisesAdd() {
      $.get("/catalogo/pais/getall")
        .done(function (response) {
          console.log("PAISES RES:", response);

          const ddl = $("#ddlPaisAdd");
          resetSelect("#ddlPaisAdd", "Seleccione");

          const arr = response.objects || response.Objects || [];
          arr.forEach(p => {
            const id = p.idPais ?? p.IdPais;
            const nombre = p.nombre ?? p.Nombre;
            ddl.append(`<option value="${id}">${nombre}</option>`);
          });

        })
        .fail(function (xhr) {
          console.log("ERROR PAISES:", xhr);
          Swal.fire("Error", "No cargaron países.", "error");
        });
    }

    function cargarEstadosAdd(idPais) {
      resetSelect("#ddlEstadoAdd", "Seleccione");
      resetSelect("#ddlMunicipioAdd", "Seleccione");
      resetSelect("#ddlColoniaAdd", "Seleccione");
      $("#CodigoPostalAdd").val("");

      $.get("/catalogo/estado/getbyidpais", { idPais: idPais })
        .done(function (response) {
          console.log("ESTADOS RES:", response);

          const ddl = $("#ddlEstadoAdd");
          const arr = response.objects || response.Objects || [];

          arr.forEach(e => {
            const id = e.idEstado ?? e.IdEstado;
            const nombre = e.nombre ?? e.Nombre;
            ddl.append(`<option value="${id}">${nombre}</option>`);
          });

        })
        .fail(function (xhr) {
          console.log("ERROR ESTADOS:", xhr);
          Swal.fire("Error", "No cargaron estados.", "error");
        });
    }

    function cargarMunicipiosAdd(idEstado) {
      resetSelect("#ddlMunicipioAdd", "Seleccione");
      resetSelect("#ddlColoniaAdd", "Seleccione");
      $("#CodigoPostalAdd").val("");

      $.get("/catalogo/municipio/getbyidestado", { idEstado: idEstado })
        .done(function (response) {
          console.log("MUNICIPIOS RES:", response);

          const ddl = $("#ddlMunicipioAdd");
          const arr = response.objects || response.Objects || [];

          arr.forEach(m => {
            const id = m.idMunicipio ?? m.IdMunicipio;
            const nombre = m.nombre ?? m.Nombre;
            ddl.append(`<option value="${id}">${nombre}</option>`);
          });

        })
        .fail(function (xhr) {
          console.log("ERROR MUNICIPIOS:", xhr);
          Swal.fire("Error", "No cargaron municipios.", "error");
        });
    }

    function cargarColoniasAdd(idMunicipio) {
      resetSelect("#ddlColoniaAdd", "Seleccione");
      $("#CodigoPostalAdd").val("");

      $.get("/catalogo/colonia/getbyidmunicipio", { idMunicipio: idMunicipio })
        .done(function (response) {
          console.log("COLONIAS RES:", response);

          const ddl = $("#ddlColoniaAdd");
          const arr = response.objects || response.Objects || [];

          arr.forEach(c => {
            const id = c.idColonia ?? c.IdColonia;
            const nombre = c.nombre ?? c.Nombre;
            const cp = c.codigoPostal ?? c.CodigoPostal ?? c.CP ?? "";
            ddl.append(`<option value="${id}" data-cp="${cp}">${nombre}</option>`);
          });

        })
        .fail(function (xhr) {
          console.log("ERROR COLONIAS:", xhr);
          Swal.fire("Error", "No cargaron colonias.", "error");
        });
    }


    $(document).on("change", "#ddlPaisAdd", function () {
      const idPais = $(this).val();
      if (idPais) cargarEstadosAdd(idPais);
    });

    $(document).on("change", "#ddlEstadoAdd", function () {
      const idEstado = $(this).val();
      if (idEstado) cargarMunicipiosAdd(idEstado);
    });

    $(document).on("change", "#ddlMunicipioAdd", function () {
      const idMunicipio = $(this).val();
      if (idMunicipio) cargarColoniasAdd(idMunicipio);
    });

    $(document).on("change", "#ddlColoniaAdd", function () {
      const cp = $("#ddlColoniaAdd option:selected").data("cp") || "";
      $("#CodigoPostalAdd").val(cp);
    });


    $(document).on("click", "#btnGuardarDireccionAdd", function () {

    const calle = $("#CalleAdd").val()?.trim() || "";
    const numeroExterior = $("#NumeroExteriorAdd").val()?.trim() || "";
    const numeroInterior = $("#NumeroInteriorAdd").val()?.trim() || "";
    const idColonia = parseInt($("#ddlColoniaAdd").val(), 10);
    const idUsuario = [[${usuario.idUsuario}]];

    if (!calle) {
        Swal.fire("Falta Calle", "La calle es obligatoria.", "warning");
        return;
    }

    if (!numeroExterior) {
        Swal.fire("Falta Número Exterior", "El número exterior es obligatorio.", "warning");
        return;
    }

    if (!idColonia || isNaN(idColonia)) {
        Swal.fire("Selecciona una colonia válida", "", "warning");
        return;
    }

    const payload = {
        idDireccion: 0,
        IdDireccion: 0,
        Calle: calle,
        NumeroExterior: numeroExterior,
        NumeroInterior: numeroInterior,
        Colonia: { idColonia: idColonia },
        Usuario: { idUsuario: idUsuario }
    };

    Swal.fire({
        title: "¿Guardar dirección?",
        text: "Se agregará una nueva dirección al usuario.",
        icon: "question",
        showCancelButton: true,
        confirmButtonColor: "#198754",
        cancelButtonColor: "#d33",
        confirmButtonText: "Sí, guardar",
        cancelButtonText: "Cancelar"
    }).then((result) => {

        if (result.isConfirmed) {
            console.log("payload", payload);
            $.ajax({
                url: "/direccion/add",
                type: "POST",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify(payload),

                success: function (res, textStatus, xhr) {
                    console.log("status:", xhr.status);
                    console.log("res",res)

                    if (res.correct) {

                        const modalEl = document.getElementById("modalAgregarDireccion");
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        modal.hide();

                        Swal.fire({
                            icon: "success",
                            title: "Dirección agregada correctamente",
                            showConfirmButton: false,
                            timer: 1500
                        }).then(() => location.reload());

                    } else {
                        
                        Swal.fire("Error", res.errorMessage || "No se pudo agregar la dirección.", "error");
                    }
                },

                error: function (xhr, textStatus, errorThrown) {
                    console.error("Status:", xhr.status);
                        console.error("TextStatus:", textStatus);
                        console.error("ErrorThrown:", errorThrown);
                        console.error("ResponseText:", xhr.responseText);
                    Swal.fire("Error", "Error de comunicación con el servidor.", "error");
                }
            });

        }

    });

});
      
    </script>
    
</html>
